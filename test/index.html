<!DOCTYPE html>
<html>
<!--
Copyright (c) 2012 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->
<head>
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="-1">
  <title>SmoothNaCl Test</title>
</head>
<body>
  <h1>SmoothNaCl Test</h1>
  <h2>Status: <code id="statusField">NO-STATUS</code></h2>
  <div>
    <p>
      <select id="preset">
        <option value="0">Subdividers</option>
        <option value="1">Green Hex</option>
        <option value="2">Fire Jellies</option>
        <option value="3">Magical Maze</option>
        <option value="4">Waterbug Gliders</option>
        <option value="5">Stitches 'n' Jitters</option>
        <option value="6">Blink Tubes</option>
        <option value="7">Oil Slick</option>
        <option value="8">Worms</option>
      </select>
      <button id="loadPreset">Load</button>
    </p>
    <select id="functionValue">
      <option value="clear">Clear</option>
      <option value="getBuffer">GetBuffer</option>
      <option value="setBrush">SetBrush</option>
      <option value="setDrawOptions">SetDrawOptions</option>
      <option value="setFullscreen">SetFullscreen</option>
      <option value="setKernel">SetKernel</option>
      <option value="setPalette">SetPalette</option>
      <option value="setRunOptions">SetRunOptions</option>
      <option value="setSmoother">SetSmoother</option>
      <option value="splat" selected>Splat</option>
    </select>
    <button id="execute">Run</button>
  </div>
  <div class="function" id="clear" hidden>
    <div>Color:<input type="text" id="clearColor" value="0"></div>
  </div>
  <div class="function" id="getBuffer" hidden>
    <div>RequestId:<input type="text" id="getBufferRequestId"></div>
  </div>
  <div class="function" id="setBrush" hidden>
    <div>Radius:<input type="text" id="setBrushRadius"></div>
    <div>Color:<input type="text" id="setBrushColor"></div>
  </div>
  <div class="function" id="setDrawOptions" hidden>
    <select id="setDrawOptionsValue">
      <option value="simulation">Simulation</option>
      <option value="disc">Disc</option>
      <option value="ring">Ring</option>
      <option value="smoother">Smoother</option>
      <option value="palette">Palette</option>
    </select>
  </div>
  <div class="function" id="setFullscreen" hidden>
    <div>Fullscreen:<input type="checkbox" id="setFullscreenValue"></div>
  </div>
  <div class="function" id="setKernel" hidden>
    <div>DiscRadius:<input type="text" id="setKernelDiscRadius"></div>
    <div>RingRadius:<input type="text" id="setKernelRingRadius"></div>
    <div>BlendRadius:<input type="text" id="setKernelBlendRadius"></div>
  </div>
  <div class="function" id="setPalette" hidden>
    <div>Repeating:<input type="checkbox" id="setPaletteRepeating"></div>
    <div>#ColorStops:<input type="text" id="setPaletteNumColorstops"></div>
    <div id="colorstops">
    </div>
  </div>
  <div class="function" id="setRunOptions" hidden>
    <div>Simulate:<input type="checkbox" id="setRunOptionsSimulate"></div>
    <div>Run:<input type="checkbox" id="setRunOptionsRun"></div>
  </div>
  <div class="function" id="setSmoother" hidden>
    <div>Type:<input type="text" id="setSmootherType"></div>
    <div>dt:<input type="text" id="setSmootherDt"></div>
    <div>b1:<input type="text" id="setSmootherB1"></div>
    <div>b2:<input type="text" id="setSmootherB2"></div>
    <div>d1:<input type="text" id="setSmootherD1"></div>
    <div>d2:<input type="text" id="setSmootherD2"></div>
    <div>mode:<input type="text" id="setSmootherMode"></div>
    <div>sigmoid:<input type="text" id="setSmootherSigmoid"></div>
    <div>mix:<input type="text" id="setSmootherMix"></div>
    <div>sn:<input type="text" id="setSmootherSn"></div>
    <div>sm:<input type="text" id="setSmootherSm"></div>
  </div>
  <div class="function" id="splat">
  </div>
  <div id="listener">
    <embed id="naclModule"
           width=512 height=512
           src="smoothlife_release.nmf"
           type="application/x-nacl"
           msg1="setBrush:10,1.0">
  </div>
  <div id="fps"></div>
  <script>
    var presets = [
      [[15.2,32.1,7.6],[3,0.329,0.15,0.321,0.145,0.709,3,2,4,0.269,0.662],[0,"#000000",3,"#f5f5c1",12,"#158a34",68,"#89e681",100]],
      [[15.2,32.1,5],[3,0.273,0.117,0.288,0.243,0.348,3,2,4,0.269,0.662],[1,"#000000",3,"#f5f5c1",8,"#158a34",17,"#89e681",20]],
      [[4,12,1],[2,0.115,0.269,0.523,0.34,0.746,3,4,4,0.028,0.147],[0,"#36065e",0,"#c24242",77,"#8a19b0",91,"#ff9900",99,"#f5c816",99]],
      [[4,12,1],[3,0.12,0.218,0.267,0.365,0.445,3,4,4,0.028,0.147],[0,"#000000",0,"#0f8a84",38,"#f5f5c1",43,"#158a34",70,"#89e681",100]],
      [[4,12,1],[0,0.09,0.276,0.27,0.365,0.445,1,4,4,0.028,0.147],[0,"#93afd9",11,"#9cf0ff",92,"#edfdff",100]],
      [[10.4,12,1],[2,0.082,0.302,0.481,0.35,0.749,2,3,4,0.028,0.147],[0,"#000000",11,"#ffffff",22,"#19a68a",85,"#6b0808",98]],
      [[7.8,27.2,2.6],[3,0.21,0.714,0.056,0.175,0.838,2,0,2,0.132,0.311],[0,"#0a1340",0,"#ffffff",55,"#4da8a3",83,"#2652ab",99,"#2f1e75",46]],
      [[4,12,1],[2,0.115,0.269,0.496,0.34,0.767,3,4,4,0.028,0.147],[0,"#b8cfcf",0,"#3f5a5c",77,"#1a330a",91,"#c0e0dc",99]],
      [[10.6,31.8,1],[1,0.157,0.092,0.256,0.098,0.607,3,4,4,0.015,0.34],[0,"#4d3e3e",0,"#9a1ac9",77,"#aaf09e",100]],
    ];

    document.getElementById('functionValue').addEventListener('change', onFunctionChanged, false);
    document.getElementById('setPaletteNumColorstops').addEventListener('change', onNumColorstopsChanged, false);
    document.getElementById('execute').addEventListener('click', onExecute, false);
    document.getElementById('loadPreset').addEventListener('click', onLoadPreset, false);
    document.getElementById('listener').addEventListener('message', onMessage, true);

    function onMessage(e) {
      document.getElementById('fps').textContent = e.data;
    }

    function onLoadPreset(e) {
      var index = parseInt(document.getElementById('preset').value, 10);
      loadPreset(index);
    }

    function loadPreset(index) {
      var preset = presets[index];
      clear('#000000');
      setKernel.apply(null, preset[0]);
      setSmoother.apply(null, preset[1]);
      setPalette.apply(null, preset[2]);
      setDrawOptions('simulation');
      setRunOptions('simulation', 'run');
      splat();
    }

    function onFunctionChanged(e) {
      var divId = this.value;
      var functionEls = document.querySelectorAll('.function');
      for (var i = 0; i < functionEls.length; ++i) {
        var visible = functionEls[i].id === divId;
        if (functionEls[i].id === divId)
          functionEls[i].removeAttribute('hidden');
        else
          functionEls[i].setAttribute('hidden');
      }
    }

    function onNumColorstopsChanged(e) {
      var colorstops = parseInt(this.value, 10);
      var colorstopEl = document.getElementById('colorstops');

      // remove all child elements.
      while (colorstopEl.firstChild) {
        colorstopEl.removeChild(colorstopEl.firstChild);
      }

      if (colorstops >= 0 && colorstops < 8) {
        for (var i = 0; i < colorstops; ++i) {
          var myEl = document.createElement('div');
          myEl.appendChild(document.createTextNode('Color'+i+':'));
          var inputEl = document.createElement('input');
          inputEl.setAttribute('type', 'text');
          myEl.appendChild(inputEl);
          colorstopEl.appendChild(myEl);

          myEl = document.createElement('div');
          myEl.appendChild(document.createTextNode('Stop'+i+':'));
          inputEl = document.createElement('input');
          inputEl.setAttribute('type', 'text');
          myEl.appendChild(inputEl);
          colorstopEl.appendChild(myEl);
        }
      }
    }

    function onExecute(e) {
      var fun = document.getElementById('functionValue').value;
      window[fun].apply(null);
    }

    function makeMessage(cmd) {
      cmd = cmd[0].toUpperCase() + cmd.slice(1);
      var args = Array.prototype.slice.call(arguments, 1);
      if (args.length)
        return cmd + ':' + Array.prototype.join.call(args, ',');
      return cmd
    }

    function getIntById(id) {
      return parseInt(document.getElementById(id).value, 10);
    }

    function getFloatById(id) {
      return parseFloat(document.getElementById(id).value);
    }

    function getValueById(id) {
      return document.getElementById(id).value;
    }

    function getCheckedById(id) {
      return document.getElementById(id).checked;
    }

    function clear() {
      var color = arguments[0] || getFloatById('clearColor');
      var msg = makeMessage('clear', color);
      postMessage(msg);
    }

    function getBuffer() {
      var requestId = arguments[0] || getIntById('getBufferRequestId');
      var msg = makeMessage('getBuffer', requestId);
      postMessage(msg);
    }

    function setBrush() {
      var radius = arguments[0] || getFloatById('setBrushRadius');
      var color = arguments[1] || getFloatById('setBrushColor');
      var msg = makeMessage('setBrush', radius, color);
      postMessage(msg);
    }

    function setDrawOptions() {
      var value = arguments[0] || getValueById('setDrawOptionsValue');
      var msg = makeMessage('setDrawOptions', value);
      postMessage(msg);
    }

    function setFullscreen() {
      var value = arguments[0] ||
          getCheckedById('setFullscreenValue') ? 'true' : 'false';
      var msg = makeMessage('setFullscreen', value);
      postMessage(msg);
    }

    function setKernel() {
      var discRadius = arguments[0] || getFloatById('setKernelDiscRadius');
      var ringRadius = arguments[1] || getFloatById('setKernelRingRadius');
      var blendRadius = arguments[2] || getFloatById('setKernelBlendRadius');
      var msg = makeMessage('setKernel', discRadius, ringRadius, blendRadius);
      postMessage(msg);
    }

    function setPalette() {
      var repeating = arguments[0] || getCheckedById('setPaletteRepeating') ? 1 : 0;
      var colorstops = [];
      if (arguments.length > 1) {
        colorstops = Array.prototype.slice.call(arguments, 1);
      } else {
        var inputEls = document.querySelectorAll('#colorstops input');
        for (var i = 0; i < inputEls.length; ++i) {
          colorstops.push(inputEls[i].value);
        }
      }

      var msg = makeMessage.apply(null, ['setPalette', repeating].concat(colorstops));
      postMessage(msg);
    }

    function setRunOptions() {
      var simulate = arguments[0] ||
          (getCheckedById('setRunOptionsSimulate') ?
              'simulation' :
              'noSimulation');
      var run = arguments[1] ||
          (getCheckedById('setRunOptionsRun') ?  'run' : 'pause');
      var msg = makeMessage('setRunOptions', simulate, run);
      postMessage(msg);
    }

    function setSmoother() {
      var type = arguments[0] || getFloatById('setSmootherType');
      var dt = arguments[1] || getFloatById('setSmootherDt');
      var b1 = arguments[2] || getFloatById('setSmootherB1');
      var d1 = arguments[3] || getFloatById('setSmootherD1');
      var b2 = arguments[4] || getFloatById('setSmootherB2');
      var d2 = arguments[5] || getFloatById('setSmootherD2');
      var mode = arguments[6] || getFloatById('setSmootherMode');
      var sigmoid = arguments[7] || getFloatById('setSmootherSigmoid');
      var mix = arguments[8] || getFloatById('setSmootherMix');
      var sn = arguments[9] || getFloatById('setSmootherSn');
      var sm = arguments[10] || getFloatById('setSmootherSm');
      var msg = makeMessage('setSmoother', type, dt, b1, d1, b2, d2, mode, sigmoid, mix, sn, sm);
      postMessage(msg);
    }

    function splat() {
      var msg = makeMessage('splat');
      postMessage(msg);
    }

    function postMessage(msg) {
      console.log(msg);
      document.getElementById('naclModule').postMessage(msg);
    }
  </script>
</body>
</html>
